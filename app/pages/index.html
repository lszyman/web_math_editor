<!DOCTYPE html>

<html lang="en" ng-app="webMathEditor">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Web Math Editor</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="../bower_components/bootstrap/dist/css/bootstrap.css">
    <link rel="stylesheet" href="../bower_components/flat-ui/dist/css/flat-ui.css">
    <link rel="stylesheet" href="../css/app.css">

    <script src="../bower_components/jquery/dist/jquery.js"></script>

    <script type="text/javascript">
        //CLIENT_ID - heroku
        var CLIENT_ID = '223087526287-k0h09nr6ah0ebbsdunaugel5bodnt3uh.apps.googleusercontent.com';
        //var CLIENT_ID = '158326088006-mm87jap1ulid7jq23dsp23hvgg7gf4mq.apps.googleusercontent.com'; // Aleksander
        //var CLIENT_ID = '223087526287-j631u4mj7s6g7rptvplu4457i0igvojh.apps.googleusercontent.com';
        var SCOPES = 'https://www.googleapis.com/auth/drive';

        /**
         * Called when the client library is loaded to start the auth flow.
         */
        function handleClientLoad() {
            window.setTimeout(checkAuth, 1);
        }

        /**
         * Check if the current user has authorized the application.
         */
        function checkAuth() {
            gapi.auth.authorize(
                    {'client_id': CLIENT_ID, 'scope': SCOPES, 'immediate': true},
                    handleAuthResult);
        }

        /**
         * Called when authorization server replies.
         *
         * @param {Object} authResult Authorization result.
         */
        function handleAuthResult(authResult) {
            var authButton = document.getElementById('authorizeButton');
            var filePicker = document.getElementById('filePicker');
            authButton.style.display = 'none';
            filePicker.style.display = 'none';
            if (authResult && !authResult.error) {
                // Access token has been successfully retrieved, requests can be sent to the API.
                filePicker.style.display = 'block';
                filePicker.onchange = uploadFile;
            } else {
                // No access token could be retrieved, show the button to start the authorization flow.
                authButton.style.display = 'block';
                authButton.onclick = function() {
                    gapi.auth.authorize(
                            {'client_id': CLIENT_ID, 'scope': SCOPES, 'immediate': false},
                            handleAuthResult);
                };
            }
        }

        /**
         * Start the file upload.
         *
         * @param {Object} evt Arguments from the file selector.
         */
        function uploadFile(evt) {
            gapi.client.load('drive', 'v2', function() {
                var file = evt.target.files[0];
                insertFile(file);
            });
        }

        /**
         * Insert new file.
         *
         * @param {File} fileData File object to read data from.
         * @param {Function} callback Function to call when the request is complete.
         */
        function insertFile(fileData, callback) {
            const boundary = '-------314159265358979323846';
            const delimiter = "\r\n--" + boundary + "\r\n";
            const close_delim = "\r\n--" + boundary + "--";

            var reader = new FileReader();
            reader.readAsBinaryString(fileData);
            reader.onload = function(e) {
                var contentType = fileData.type || 'application/octet-stream';
                var metadata = {
                    'title': fileData.name,
                    'mimeType': contentType
                };

                var base64Data = btoa(reader.result);
                var multipartRequestBody =
                        delimiter +
                        'Content-Type: application/json\r\n\r\n' +
                        JSON.stringify(metadata) +
                        delimiter +
                        'Content-Type: ' + contentType + '\r\n' +
                        'Content-Transfer-Encoding: base64\r\n' +
                        '\r\n' +
                        base64Data +
                        close_delim;

                var request = gapi.client.request({
                    'path': '/upload/drive/v2/files',
                    'method': 'POST',
                    'params': {'uploadType': 'multipart'},
                    'headers': {
                        'Content-Type': 'multipart/mixed; boundary="' + boundary + '"'
                    },
                    'body': multipartRequestBody});
                if (!callback) {
                    callback = function(file) {
                        console.log(file)
                    };
                }
                request.execute(callback);
            }
        }

        /**
         * Print a file's content.
         *
         * @param {String} fileId ID of the file to print content for.
         */
        function printFile(fileId) {
            var request = gapi.client.request({
                'path': '/drive/v2/files/' + fileId,
                'method': 'GET',
                callback: function ( theResponseJS, theResponseTXT ) {
                    var myToken = gapi.auth.getToken();
                    var myXHR   = new XMLHttpRequest();
                    myXHR.open('GET', theResponseJS.downloadUrl, true );
                    myXHR.setRequestHeader('Authorization', 'Bearer ' + myToken.access_token);
                    myXHR.onreadystatechange = function( theProgressEvent ) {
                        if (myXHR.readyState == 4) {
                            //1=connection ok, 2=Request received, 3=running, 4=terminated
                            if ( myXHR.status == 200 ) {
                                console.log(myXHR.response);
                                $('#mathExpression').val(myXHR.response);
                            }
                        }
                    };
                    myXHR.send();
                }
            });
        }

        function executePrintFile() {
            var fileId = $('#fileIdLoadFromGoogleDrive').val();
            printFile(fileId)
        }


        /**
         * Retrieve a list of File resources.
         *
         * @param {Function} callback Function to call when the request is complete.
         */
        function retrieveAllFiles() {
            var request = gapi.client.request({
                'path': '/drive/v2/files',
                'method': 'GET',
                'callback': function(result) {


                    var tableCode = "";
                    for (var i = 0; i < result.items.length; i++) {
                        var item = result.items[i];
                        tableCode += "<tr><td>"  + i + "</td><td>" + item.title + "</td><td>" + item.id + "</td>" +
                            "<td class='openFile' style='cursor:pointer' data-file='" + item.id + "'>" +
                            "<span class='glyphicon glyphicon-eye-open' aria-hidden='true'></span></td>" +
                            "<td class='deleteFile' style='cursor:pointer' data-file='" + item.id + "'>" +
                            "<span class='glyphicon glyphicon-remove' aria-hidden='true'></span></td></tr>";
                    }

                    $("#filesList").css("display", "block");
                    $("#filesList > tbody").html(tableCode);
                }
            });
        }

        function deleteFile(fileId) {
            var request = gapi.client.request({
                'path': '/drive/v2/files/' + fileId,
                'method': 'DELETE',
                'callback': function(result) {
                    $("#refreshFilesListButton").click();
                }
            });
        }

    </script>
    <script type="text/javascript" src="https://apis.google.com/js/client.js?onload=handleClientLoad"></script>
</head>

<body>

<nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar"
                    aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="#/index">Web Math Editor</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
                <li class="active"><a href="#">Home</a></li>
                <li><a href="#about">About</a></li>
                <li><a href="#contact">Contact</a></li>
                <li class="dropdown">
                    <a href="#/index" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Dropdown
                        <span class="caret"></span></a>
                    <ul class="dropdown-menu" role="menu">
                        <li><a href="#">Action</a></li>
                        <li><a href="#">Another action</a></li>
                        <li><a href="#">Something else here</a></li>
                        <li class="divider"></li>
                        <li class="dropdown-header">Nav header</li>
                        <li><a href="#">Separated link</a></li>
                        <li><a href="#">One more separated link</a></li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="container">
    <div class="jumbotron">
        <h1>Web Math Editor</h1>

        <div>
            <input type="button" id="refreshFilesListButton" value="Get files list">
            <table class="table table-striped table-condensed" style="display:none" id="filesList">
                <thead>
                <tr>
                    <th>#</th>
                    <th>name</th>
                    <th>ID</th>
                    <th></th>
                    <th></th>
                </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>


        <label for="fileIdLoadFromGoogleDrive"><b>File Id: </b>
            <input id="fileIdLoadFromGoogleDrive" type="text" name="fileIdLoadFromGoogleDrive" value="0B47CPHRFDjO-NjVyWTB3a3o3V2s" class="form-control" style="width: 300px">
            <input type="button" id="loadFromGoogleDrive" value="Load file's content" class="btn btn-primary" onclick="executePrintFile()"/>
        </label>

        <div ng-view></div>

        <input type="file" id="filePicker" style="display: none" />
        <input type="button" id="authorizeButton" style="display: none" value="Save to Google Drive" />
    </div>

    <hr>
    <footer>
        <p>Łukasz Szymański, Krzysztof Klimek, Aleksander Chrabąszcz © 2015</p>
    </footer>
</div>

<script src="../bower_components/flat-ui/dist/js/flat-ui.js"></script>
<script src="../bower_components/angular/angular.js"></script>
<script src="../bower_components/angular-route/angular-route.js"></script>
<script src="../bower_components/mathjs/dist/math.js" type="text/javascript"></script>
<script src="../js/app.js"></script>
<script src="../js/controllers.js"></script>

<script type="text/javascript">

    $(function() {
        $("#refreshFilesListButton").click(function(event) {
            retrieveAllFiles(function(result) {
                console.log(result);
            });
        });

        $(document).on("click", ".deleteFile", function(event) {
            if (confirm("Going to delete the file. Are you sure?")) {
                var fileId = $(event.target).closest(".deleteFile").data("file");
                deleteFile(fileId);
            }
        });

        $(document).on("click", ".openFile", function(event) {
            var fileId = $(event.target).closest(".openFile").data("file");
            printFile(fileId);
        });
    });
</script>
</body>
</html>
